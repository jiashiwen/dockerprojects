# open_kb.leju.com.conf
# 	include D:/Dev/PHPHTDOCS/_cache/etc/open_*.conf;

# 本地开发 Hosts 设置
#127.0.0.1			ld.baike.leju.com			# 知识系统域名
#127.0.0.1			ld.m.baike.leju.com			# 移动端知识系统域名
#127.0.0.1			ld.api.baike.leju.com		# 知识系统接口域名
#127.0.0.1			ld.admin.baike.leju.com		# 知识系统后台域名
#127.0.0.1			p.baike.leju.com			# 知识系统静态资源


# start [ p.baike.leju.com ]
server {
	server_name ld.p.baike.leju.com p.baike.leju.com;
	listen 80;

	root /Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/knowledge/p;

	add_header Access-Control-Allow-Origin *;
	add_header Access-Control-Allow-Headers X-Requested-With;
	add_header Access-Control-Allow-Methods GET,POST,OPTIONS;

	location / {
		index index.html;
	}
	#expires off;
	location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|eot|ttf|woff|woff2|svg)$ {
		expires 30d;
	}

	location ~ .*\.(js|css)?$ {
		expires 30d;
	}
} # end of public static files domain : [ p.baike.leju.com ]

# start [ baike.leju.com ]
server {
	server_name ld.baike.leju.com ld.m.baike.leju.com;
	listen 80;

	access_log /Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/.tmp/baike.access;
	error_log /Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/.tmp/baike.error;

	root /Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/knowledge;

	fastcgi_buffer_size 1024k;
	fastcgi_buffers 32 1024k;
	fastcgi_busy_buffers_size 2048k;

	set $VISITOR_DEVICE "pc";
	if ( $host ~ "m.baike.leju.com" ) {
		set $VISITOR_DEVICE "mobile";
	}

	location / {
		try_files $uri @rewrite;
	}
	location @rewrite {
		set $static 0;
		if  ($uri ~ \.(css|js|jpg|jpeg|png|gif|ico|woff|eot|svg|css\.map|min\.map)$) {
			set $static 1;
		}
		if ($static = 0) {
			rewrite ^/(.*)$ /index.php?s=/$1;
		}
	}

	location ~ \.php/ {
		if ($request_uri ~ ^(.+\.php)(/.+?)($|\?)) { }
		fastcgi_pass 127.0.0.1:9000;
		include fastcgi_params;
		fastcgi_param SCRIPT_NAME     $1;
		fastcgi_param PATH_INFO       $2;
		fastcgi_param SCRIPT_FILENAME $document_root$1;
		include /Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/etc/fastcgi_params;
	}

	location ~ \.php$ {
		fastcgi_pass 127.0.0.1:9000;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		include fastcgi_params;
		include /Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/etc/fastcgi_params;
	}

#	location / {
#		index index.php index.html index.htm;
#		if (!-e $request_filename) {
#			rewrite ^/index.php(.*)$ /index.php?s=$1 last;
#			rewrite ^(.*)$ /index.php?s=$1 last;
#			break;
#		}
#	}

#	location ~ .+\.php($|/) {
#		fastcgi_split_path_info ^(.+\.php)(/.+)$;
#		fastcgi_pass		127.0.0.1:9000;
#		fastcgi_index		index.php;
#		fastcgi_param		SCRIPT_FILENAME		$document_root$fastcgi_script_name;
#		fastcgi_param		SCRIPT_NAME			$fastcgi_script_name;
#		include				fastcgi_params;
#		include				/Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/etc/fastcgi_params;
#		fastcgi_param		VISITOR_DEVICE		$VISITOR_DEVICE;
#	}

	location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|ttf|woff|svg)$ {
		expires off;
	}

	location ~ .*\.(js|css)?$ {
		expires off;
	}

	location ~ /Uploads/.*\.php$ {
		deny all;
	}
	location ~ /\.ht {
		deny  all;
	}
} # end of kb frontend domain : [ baike.leju.com ]


# start [ admin.baike.leju.com ]
server {
	server_name ld.admin.baike.leju.com;
	listen 80;

	access_log /Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/.tmp/admin.access;
	error_log /Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/.tmp/admin.error;

	root /Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/knowledge/admin;

	fastcgi_buffer_size 1024k;
	fastcgi_buffers 32 1024k;
	fastcgi_busy_buffers_size 2048k;

	location / {
		index is.php index.html index.htm;
		if (!-e $request_filename) {
			rewrite ^/is.php(.*)$ /index.php?s=$1 last;
			rewrite ^(.*)$ /is.php?s=$1 last;
			break;
		}
	}

	location ~ .+\.php($|/) {
		fastcgi_pass		127.0.0.1:9000;
		fastcgi_index		is.php;
		fastcgi_param		SCRIPT_FILENAME  $document_root$fastcgi_script_name;
		include				fastcgi_params;
		include				/Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/etc/fastcgi_params;
	}

	location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|ttf|woff|svg)$ {
			expires off;
	}

	location ~ .*\.(js|css)?$ {
			expires off;
	}
} # end of admin backend domain : [ admin.baike.leju.com ]

# start [ api.baike.leju.com ]
server {
	server_name ld.api.baike.leju.com;
	listen 80;

	access_log /Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/.tmp/api.access;
	error_log /Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/.tmp/api.error;

	root /Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/knowledge/api;

	fastcgi_buffer_size 1024k;
	fastcgi_buffers 32 1024k;
	fastcgi_busy_buffers_size 2048k;

	location / {
		index is.php index.html index.htm;
		if (!-e $request_filename) {
			rewrite ^/index.php(.*)$ /is.php?s=$1 last;
			rewrite ^(.*)$ /is.php?s=$1 last;
			break;
		}
	}

	location ~ .+\.php($|/) {
		fastcgi_pass		127.0.0.1:9000;
		fastcgi_index		is.php;
		fastcgi_param		SCRIPT_FILENAME  $document_root$fastcgi_script_name;
		include				fastcgi_params;
		include				/Volumes/Data/Dev/vmshare/ubuntu1510/vhosts/knowledge/etc/fastcgi_params;
	}

	location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|ttf|woff|svg)$ {
			expires off;
	}

	location ~ .*\.(js|css)?$ {
			expires off;
	}
} # end of api service domain : [ api.baike.leju.com ]
